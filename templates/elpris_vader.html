<!DOCTYPE html>
<html lang="sv">
{% extends "layout.html" %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <title>Elpris & V√§der</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h2>üìà Elpris & V√§der {{ selected_date }}</h2>
    <form method="get" action="/elprisvader">
        <input type="date" name="datum" value="{{ selected_date }}">
        <button type="submit">Visa</button>
    </form>

    <h3>‚òÄÔ∏è V√§der ({{ selected_date }})</h3>
    <canvas id="weatherChart" height="100"></canvas>

    <h3>‚ö° Elpriser ({{ (selected_date + timedelta(days=1)).strftime('%Y-%m-%d') }})</h3>
    <canvas id="priceChart" height="100"></canvas>

    <table>
        <thead>
            <tr>
                <th>Tid</th>
                <th>Temp (¬∞C)</th>
                <th>Vind (m/s)</th>
                <th>Symbol</th>
                <th>Elpris (√∂re/kWh)</th>
            </tr>
        </thead>
        <tbody>
            {% for row in weatherdata %}
            <tr>
                <td>{{ row.timestamp.strftime('%H:%M') }}</td>
                <td>{{ row.temperature }}</td>
                <td>{{ row.vind }}</td>
                <td>{{ row.symbol_code }}</td>
                <td>
                    {% for p in elprisdata %}
                        {% if p.datetime.hour == row.timestamp.hour %}
                            {{ p.price }}
                        {% endif %}
                    {% endfor %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <p><strong>Medeltemperatur:</strong> {{ avg_temp }} ¬∞C</p>
    <p><strong>Medelvind:</strong> {{ avg_wind }} m/s</p>
    <p><strong>Medelpris:</strong> {{ avg_price }} √∂re/kWh</p>

    <script>
        const weatherLabels = {{ weatherdata|map(attribute='timestamp')|map('string')|list|tojson }}.map(t => t.slice(11, 16));
        const tempData = {{ weatherdata|map(attribute='temperature')|list|tojson }};
        const windData = {{ weatherdata|map(attribute='vind')|list|tojson }};
        const priceData = {{ elprisdata|map(attribute='price')|list|tojson }};

        new Chart(document.getElementById('weatherChart'), {
            type: 'line',
            data: {
                labels: weatherLabels,
                datasets: [
                    {
                        label: 'Temperatur (¬∞C)',
                        data: tempData,
                        borderWidth: 2,
                        fill: false
                    },
                    {
                        label: 'Vind (m/s)',
                        data: windData,
                        borderWidth: 2,
                        fill: false
                    }
                ]
            }
        });

        new Chart(document.getElementById('priceChart'), {
            type: 'line',
            data: {
                labels: weatherLabels,
                datasets: [{
                    label: 'Elpris (√∂re/kWh)',
                    data: priceData,
                    borderWidth: 2,
                    fill: false
                }]
            }
        });
    </script>
</body>
{% endblock %}
</html>
