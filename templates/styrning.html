{% extends "base.html" %}
{% block content %}
<h2>Styrning – Billigaste timmarna för drift</h2>

<form method="get" action="/styrning" style="margin-bottom: 1em;">
  <label for="datum">Välj datum:</label>
  <input type="date" id="datum" name="datum" value="{{ selected_date }}">

  <label for="n" style="margin-left: 12px;">Antal billiga timmar (N):</label>
  <input type="number" id="n" name="n" min="1" max="24" value="{{ top_n }}" style="width: 70px;">
  <button type="submit">Visa</button>
</form>

<p><strong>Valt datum:</strong> {{ selected_date }}</p>

{% if no_price %}
  <p style="color: orange;"><strong>⚠️ Inga elpriser publicerade för {{ selected_date }}.</strong></p>
{% else %}

<div class="chart-wrapper">
  <canvas id="elprisChart"></canvas>
</div>

<p><strong>Valda timmar för styrning ({{ top_n }} st, kronologiskt):</strong>
  {% if selected_labels_chrono %}
    {{ selected_labels_chrono | join(", ") }}
  {% else %}-{% endif %}
</p>

<h3>Trappstege – billigast → dyrast</h3>
<table class="梯">
  <thead><tr><th>#</th><th>Tid</th><th style="text-align:right;">Pris (kr/kWh)</th></tr></thead>
  <tbody>
    {% for row in sorted_by_price %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ row.label }}</td>
      <td style="text-align:right;">{{ row.price | float | round(4) }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Chart.js + datalabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
const labels    = {{ labels      | tojson | default("[]") }};
const values    = {{ values      | tojson | default("[]") }};
const barColors = {{ bar_colors  | tojson | default("[]") }};

// Registrera pluginet (viktigt för att datalabels ska funka)
Chart.register(ChartDataLabels);

if (labels.length && values.length) {
  const ctx = document.getElementById('elprisChart').getContext('2d');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: "kr/kWh",
        data: values,
        backgroundColor: barColors
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { top: 120 } },   // extra utrymme för etiketter
      plugins: {
        legend: { display: false },
        datalabels: {
          display: true,
          anchor: 'end',
          align: 'end',
          rotation: -90,
          color: '#000',
          font: { weight: 'bold', size: 16 },
          formatter: (val) => {
            return (val ?? 0).toLocaleString('sv-SE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " kr";
          }
        },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const v = ctx.raw ?? 0;
              return v.toLocaleString('sv-SE', {minimumFractionDigits: 4, maximumFractionDigits: 4}) + " kr/kWh";
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          suggestedMax: Math.max(...values, 0) * 1.15,
          title: { display: true, text: 'kr/kWh' }
        },
        x: {
          title: { display: true, text: 'Tidpunkt (svensk tid)' }
        }
      }
    }
  });
}
</script>

{% endif %}

<style>
.chart-wrapper { max-width: 1000px; margin: 0 auto; height: 500px; }
canvas { width: 100% !important; height: 100% !important; display: block; }
table.梯 { border-collapse: collapse; width: 100%; margin-top: 10px; font-size: 0.95em; }
table.梯 th, table.梯 td { padding: 8px 12px; border-bottom: 1px solid #e5e7eb; }
table.梯 thead th { background: #f7f7f7; }
table.梯 tbody tr:nth-child(odd) { background: #fbfdff; }
</style>
{% endblock %}
