{% extends "base.html" %}

{% block content %}
	<h2>EXO – kontrollpanel</h2>

	<p>
		<strong>EXO_URL:</strong>
		{% if exo_url %}
			<span style="color: #0a7;">konfigurerad</span>
		{% else %}
			<span style="color: #c40;">saknas</span>
		{% endif %}
		<br>
		<strong>EXO_TOKEN:</strong>
		{% if has_token %}
			<span style="color: #0a7;">konfigurerad</span>
		{% else %}
			<span style="color: #c40;">saknas</span>
		{% endif %}
	</p>

	<div style="margin: 10px 0; padding: 10px; border: 1px solid #eee; border-radius: 8px; background: #fafafa;">
		<strong>Val:</strong>
		site=<code>{{ selected_site or '-' }}</code>,
		dag=<code>{{ day_str }}</code>,
		build=<code>{{ '1' if build else '0' }}</code>,
		N=<code>{{ n_arg or '-' }}</code>,
		cheap_pct=<code>{{ cheap_arg or '-' }}</code>,
		exp_pct=<code>{{ exp_arg or '-' }}</code>
		<br>
		<small>
			Tips: börja med <strong>Preview</strong> eller <strong>Dry-run</strong>. <strong>Push</strong> kräver att du skriver <code>PUSH</code>.
			{% if not exo_url %}
				Push/Dry-run behöver att <code>EXO_URL</code> sätts i <code>/home/runerova/.smartweb.env</code> och att <code>smartweb</code> startas om.
			{% endif %}
		</small>
	</div>

	{% if status_msg %}
		<p style="color:#0a7;"><strong>✅ {{ status_msg }}</strong></p>
	{% endif %}
	{% if error_msg %}
		<p style="color:#c40;"><strong>⚠️ {{ error_msg }}</strong></p>
	{% endif %}

	<form method="post" style="margin-bottom: 1em; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
		<label for="site_code"><strong>Site:</strong></label>
		<select id="site_code" name="site_code">
			{% for s in site_codes %}
				<option value="{{ s }}" {% if s == selected_site %}selected{% endif %}>{{ s }}</option>
			{% endfor %}
		</select>
		{% if not site_codes %}
			<span style="color:#c40; margin-left: 8px;">(kunde inte läsa sites från DB)</span>
		{% endif %}

		<label for="day" style="margin-left: 12px;"><strong>Dag:</strong></label>
		<input type="date" id="day" name="day" value="{{ day_str }}">

		<div style="margin-top: 10px;">
			<label><strong>Parametrar (valfritt):</strong></label><br>
			<label for="n">N:</label>
			<input id="n" name="n" type="number" min="1" max="96" value="{{ n_arg }}" style="width: 80px;">
			<label for="cheap_pct" style="margin-left: 12px;">cheap_pct:</label>
			<input id="cheap_pct" name="cheap_pct" type="text" value="{{ cheap_arg }}" style="width: 90px;" placeholder="-0.30">
			<label for="exp_pct" style="margin-left: 12px;">exp_pct:</label>
			<input id="exp_pct" name="exp_pct" type="text" value="{{ exp_arg }}" style="width: 90px;" placeholder="0.50">
			<label style="margin-left: 12px;">
				<input type="checkbox" name="build" value="1" {% if build %}checked{% endif %}>
				Build (skapa payload i DB)
			</label>
		</div>

		<div style="margin-top: 10px;">
			<button type="submit" name="action" value="preview">Preview payload</button>
			<button type="submit" name="action" value="dry_run">Dry-run push</button>
		</div>

		<hr style="margin: 12px 0;">
		<div>
			<strong>Skicka (push)</strong> – kräver bekräftelse:<br>
			<label for="confirm">Skriv PUSH:</label>
			<input id="confirm" name="confirm" type="text" value="" style="width: 90px;">
			<label for="timeout" style="margin-left: 12px;">timeout:</label>
			<input id="timeout" name="timeout" type="number" min="1" max="120" value="20" style="width: 80px;"> sec
			<button type="submit" name="action" value="push" style="margin-left: 12px;">Push till EXO</button>
		</div>
	</form>

	{% if result_json %}
		<h3>Resultat</h3>
		<pre style="white-space: pre-wrap; background:#f7f7f7; padding: 10px; border-radius: 8px; border: 1px solid #eee;">{{ result_json }}</pre>
	{% endif %}

	<hr style="margin: 18px 0;">

	<h3>Arrigo PVL (Project Builder “api”-sidan)</h3>
	<p>
		<strong>ARRIGO_LOGIN_URL:</strong>
		{% if arrigo_has_login_url %}<span style="color:#0a7;">konfigurerad</span>{% else %}<span style="color:#c40;">saknas</span>{% endif %}
		<br>
		<strong>ARRIGO_GRAPHQL_URL:</strong>
		{% if arrigo_has_graphql_url %}<span style="color:#0a7;">konfigurerad</span>{% else %}<span style="color:#c40;">saknas</span>{% endif %}
		<br>
		<strong>ARRIGO_USER/ARRIGO_PASS:</strong>
		{% if arrigo_has_user and arrigo_has_pass %}<span style="color:#0a7;">konfigurerad</span>{% else %}<span style="color:#c40;">saknas</span>{% endif %}
		<br>
		<strong>ARRIGO_PVL_PATH/ARRIGO_PVL_B64:</strong>
		{% if arrigo_has_pvl %}<span style="color:#0a7;">konfigurerad</span>{% else %}<span style="color:#c40;">saknas</span>{% endif %}
		<br>
		<strong>ARRIGO_TOKEN_CACHE_FILE:</strong>
		{% if arrigo_token_cache_exists %}
			<span style="color:#0a7;">finns</span>
		{% else %}
			<span style="color:#c40;">saknas</span>
		{% endif %}
		<br>
		<small style="color:#555;">{{ arrigo_token_cache_file }}</small>
		<br>
		<strong>PVL (decoded):</strong>
		<code>{{ arrigo_pvl_decoded or '-' }}</code>
	</p>

	{% if arrigo_error %}
		<p style="color:#c40;"><strong>⚠️ {{ arrigo_error }}</strong></p>
	{% endif %}

	<form method="post" style="margin-bottom: 1em; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
		<div>
			<label for="arrigo_filter"><strong>Filter (valfritt):</strong></label>
			<input id="arrigo_filter" name="arrigo_filter" type="text" value="{{ arrigo_filter or '' }}" placeholder="t.ex. PRICE_ eller Huvudcentral" style="width: 280px;">
			<label for="arrigo_limit" style="margin-left: 12px;"><strong>Limit:</strong></label>
			<input id="arrigo_limit" name="arrigo_limit" type="number" min="1" max="5000" value="{{ arrigo_limit or 200 }}" style="width: 90px;">
			<label style="margin-left: 12px;">
				<input type="checkbox" name="arrigo_show_values" value="1" {% if arrigo_show_values %}checked{% endif %}>
				Visa värden
			</label>
		</div>
		<div style="margin-top: 10px;">
			<button type="submit" name="action" value="arrigo_list">Lista variabler från api-sidan</button>
			{% if arrigo_total %}
				<span style="margin-left: 12px; color:#555;">Totalt i PVL: <code>{{ arrigo_total }}</code> (visar max <code>{{ arrigo_vars|length }}</code>)</span>
			{% endif %}
		</div>
	</form>

	{% if arrigo_vars and arrigo_vars|length > 0 %}
		<div style="max-height: 420px; overflow: auto; border: 1px solid #eee; border-radius: 8px;">
			<table style="width: 100%; border-collapse: collapse;">
				<thead>
					<tr style="background: #fafafa;">
						<th style="text-align:left; padding: 8px; border-bottom: 1px solid #eee;">technicalAddress</th>
						{% if arrigo_show_values %}
							<th style="text-align:left; padding: 8px; border-bottom: 1px solid #eee;">value</th>
						{% endif %}
					</tr>
				</thead>
				<tbody>
					{% for v in arrigo_vars %}
						<tr>
							<td style="padding: 6px 8px; border-bottom: 1px solid #f0f0f0;"><code>{{ v.technicalAddress }}</code></td>
							{% if arrigo_show_values %}
								<td style="padding: 6px 8px; border-bottom: 1px solid #f0f0f0;"><code>{{ v.value }}</code></td>
							{% endif %}
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	{% endif %}

{% endblock %}
