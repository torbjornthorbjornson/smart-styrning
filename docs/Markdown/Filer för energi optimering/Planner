# 04_Planner_Vision.md
## âš™ï¸ Planner â€“ Vision, Struktur & NÃ¤sta Steg

### ğŸ§© Ã–vergripande syfte
Planner Ã¤r hjÃ¤rtat i hela den adaptiva styrningen.  
Dess uppgift Ã¤r att ta reda pÃ¥ **nÃ¤r** under dygnet varmvatten (eller annan last) ska vara aktiv,  
utifrÃ¥n pris, kapacitet, budget, tidfÃ¶nster och anvÃ¤ndarpreferenser.

Planner fattar beslut utifrÃ¥n principen:
> â€œGÃ¶r rÃ¤tt sak vid rÃ¤tt tid â€” men bara en gÃ¥ng per cykel.â€

---

## ğŸ“ Grundlogik

1. **InlÃ¤sning av aktiv profil (R):**  
   HÃ¤mtar runtime-vÃ¤rden frÃ¥n den profil som valts i HMI.  
   Exempel: `VVP_P1_H_BASE â†’ VVP_H_BASE_R`

2. **Clampning:**  
   SÃ¤kerstÃ¤ller giltiga vÃ¤rden: 0â€“24 timmar, 0â€“96 perioder.

3. **Trigger-hantering:**  
   Planner kÃ¶rs endast nÃ¤r nÃ¥got fÃ¶rÃ¤ndrats:
   - UI â†’ ProfilÃ¤ndring (via `VVP_UI_CHANGE_FLAG`)
   - Profilbyte (`VVP_PROFILE_UI <> VVP_PROFILE`)
   - Manuell start (`VVP_PLAN_NOW`)
   - SjÃ¤lvinlÃ¤rning (t.ex. `VV_Control` sÃ¤tter `VVP_PLAN_NOW = 1`)

4. **Planeringskropp:**  
   Planen byggs i 96 kvartstimmar utifrÃ¥n prioritering:
   1. Billigaste perioder (`RANK_W`)
   2. Budget i ankarfÃ¶nster (Morgon/kvÃ¤ll)
   3. In-row och gap-regler
   4. Slack (extra kapacitet vid behov)
   5. Trim (ta bort dyraste om planen Ã¶verskrider mÃ¥let)

5. **Snapshot:**  
   Lagrar resultat och fÃ¶rbereder fÃ¶r nÃ¤sta cykel.

---

## ğŸ§® Aktuellt lÃ¤ge (status Q4 2025)

âœ… *Profiler synkas korrekt mellan HMI och runtime*  
âœ… *Plan triggas bara en gÃ¥ng per cykel*  
âœ… *Basplan och seedning fungerar (billigast fÃ¶rst)*  
âœ… *AnkarfÃ¶nster bÃ¶rjar fungera (morgon/kvÃ¤ll)*  
âš™ï¸ *Clampning fungerar men behÃ¶ver finjusteras fÃ¶r extrema vÃ¤rden*  
âš™ï¸ *Inrow/gap behÃ¶ver fÃ¶rbÃ¤ttrad prioriteringslogik*  
âš™ï¸ *Trim behÃ¶ver tydligare funktion eller tas bort helt*  
ğŸš§ *SjÃ¤lvinlÃ¤rningen (VV_Control) ger feedback men integreras inte Ã¤nnu*

---

## ğŸ¯ Steg fÃ¶r steg framÃ¥t

### **Steg 1 â€“ Stabilisering (pÃ¥gÃ¥ende)**
Syfte: Undvika Ã¶verdrivet antal timmar (89â€“96) och dubbletter.
- SÃ¤kerstÃ¤ll att `pickedP` aldrig Ã¶verskrider `needP + CAP_SLACK_P`.
- HÃ¥ll fast vid â€œplan kÃ¶rs max en gÃ¥ng/cykelâ€.
- BekrÃ¤fta att `VVP_PLAN_BUSY` fungerar som Ã¥terintrÃ¤deslÃ¥s.

### **Steg 2 â€“ FÃ¶rfining av ankarfÃ¶nster**
Syfte: Exakta fÃ¶nster, rÃ¤tt kvartsomvandling och respekt fÃ¶r budget.
- Kontrollera att `m_startI`, `m_lenI`, `e_startI`, `e_lenI` konverteras 1:1 frÃ¥n timmar (Ã—4).
- InfÃ¶r clampning av lÃ¤ngd: `budgetM_P â‰¤ m_lenI`, `budgetE_P â‰¤ e_lenI`.
- SÃ¤kerstÃ¤ll att planering aldrig fyller utanfÃ¶r definierade fÃ¶nster.
- Testa edge-case: wrap-around (t.ex. 22:00â€“02:00).

### **Steg 3 â€“ Inrow och Gap-regler**
Syfte: JÃ¤mn fÃ¶rdelning och effektbegrÃ¤nsning.
- Revidera logik fÃ¶r `MAX_INROW_P` och `MAX_GAP_P`.
- SÃ¤kerstÃ¤ll att billigaste timmar prioriteras Ã¤ven inom dessa regler.
- Kontrollera interaktion med slack (sÃ¥ gap-fill inte Ã¶verskriver budget).

### **Steg 4 â€“ Trim-funktionens framtid**
Syfte: UtvÃ¤rdera behov.
- Om trim anvÃ¤nds som â€œnÃ¶dbromsâ€ â†’ hÃ¥ll kvar.  
- Om den lappar Ã¶ver logikfel â†’ ta bort och hantera i gap/inrow istÃ¤llet.  
- Dokumentera vilken effekt trim har vid olika scenarier.

### **Steg 5 â€“ Samspel med sjÃ¤lvinlÃ¤rning**
Syfte: GÃ¶ra Planner adaptiv.  
- NÃ¤r VV_Control rapporterar avvikelse (`err_h`), justera `VVP_H_BASE_R`.
- Skapa grÃ¤nssnitt mellan Planner och Controller:  
  â€œHur gick det igÃ¥r?â€ â†’ â€œJustera planen i natt.â€
- LÃ¥t Planner svara pÃ¥ feedback genom att uppdatera profilens basvÃ¤rde.

### **Steg 6 â€“ Diagnostik och visuell verifikation**
Syfte: GÃ¶r det mÃ¤tbart.
- LÃ¤gg till `PLAN_CNT_VV`, `haveM_P`, `haveE_P`, `pickedP` i grafisk vy.
- Skapa fÃ¤rgkodad 96-periodgraf i HMI eller webinterface:
  - BlÃ¥ = basperiod
  - GrÃ¶n = ankarperiod
  - Gul = slack
  - RÃ¶d = trim

---

## ğŸ’¡ FÃ¶rslag: ny budgetlogik (fÃ¶r framtida version)
Om bÃ¥de `BUDGET_M_MIN` och `BUDGET_E_MIN` Ã¤r angivna:  
â†’ slÃ¥ ihop dessa till ett sammanlagt vÃ¤rde och lÃ¤gg till i `CAP_SLACK_H_R`.  
DÃ¥ fÃ¥r systemet automatisk kompensation mellan dyra och billiga timmar,  
utan att Ã¶verlasta planen.

---

## ğŸ” SÃ¤kerhets- och robusthetsprinciper

| Risk | Ã…tgÃ¤rd |
|------|---------|
| Plan kÃ¶rs fÃ¶r ofta | LÃ¥s med `VVP_PLAN_BUSY` + flaggsamling |
| Felaktiga timmar (89h-bugg) | clampning av `needP`, `CAP_SLACK_P` och `pickedP` |
| OÃ¤ndliga gapfyllningsloopar | Bryt efter `pickedP >= slackTargetP` |
| Fel typkonvertering | anvÃ¤nd konsekvent `CvR`, `CvI`, `CvX` beroende pÃ¥ kÃ¤lla |
| FÃ¶rlorad synk mellan UI och profil | Skuggsystem (`_PREV`) + `VVP_UI_CHANGE_FLAG` |

---

## ğŸ“Š Vision
NÃ¤r Planner Ã¤r klar ska den:
- TÃ¤nka fÃ¶re varje dag â€“ inte reagera i efterhand.  
- SjÃ¤lvjustera fÃ¶rbrukning mot pris och behov.  
- Ge konsekvent styrning oavsett vÃ¤der, tid eller belastning.  
- Kunna fÃ¶rklara *varfÃ¶r* den planerade som den gjorde.  

> â€œPlanner Ã¤r inte bara en kalkylator â€” det Ã¤r ett sinne fÃ¶r timing.â€

---

## ğŸ§­ Sammanfattning
Planner Ã¤r det som skiljer ett vanligt styrsystem frÃ¥n en **adaptiv intelligens**.  
Den fÃ¶rbinder mÃ¤nniska och maskin genom logik, fÃ¶rutsÃ¤gelse och sjÃ¤lvjustering.  
NÃ¤r den fungerar till 100 % blir den navet i hela systemet,  
och grunden fÃ¶r kommande AI-styrda versioner.

---

