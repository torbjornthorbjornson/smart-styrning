# 03_Arkitektur_helhet.md
## ğŸ§  Adaptiv Driftsmodell â€“ Helhetsarkitektur

### ğŸŒ GrundidÃ©
Systemet â€œSmart Fastighetsstyrningâ€ bygger pÃ¥ en adaptiv (sjÃ¤lvlÃ¤rande) styrning fÃ¶r vÃ¤rme, varmvatten och energifÃ¶rdelning.  
All logik fÃ¶ljer principen: **en kÃ¤lla, ett beslut, mÃ¥nga resultat.**  
Varje modul har sin roll men samverkar genom gemensamma variabler och gemensamma mÃ¥l.

MÃ¥let Ã¤r att skapa **vÃ¤rldens bÃ¤sta energioptimeringssystem** â€” inte genom slump, utan genom:
- Fysisk fÃ¶rstÃ¥else av byggnaden.
- Datadriven planering med sjÃ¤lvinlÃ¤rning.
- Omtanke mellan moduler (â€œkompislogikâ€).
- LÃ¥g energikostnad utan att tumma pÃ¥ komfort.

---

## ğŸ§© Systemets huvuddelar

| Modul | Huvuduppgift | Typ |
|-------|---------------|-----|
| **Estimator** | RÃ¤knar fram basbehov (h/timmar, dygnsprofil) baserat pÃ¥ profil, vÃ¤der, topologi | Matematiskt block |
| **Planner** | Skapar plan i 96 kvartstimmar utifrÃ¥n basbehov, prisranking och ankare | Logiskt block |
| **Controller** | VerkstÃ¤ller plan, hanterar vÃ¤xling, Ã¶vervakning, sjÃ¤lvinlÃ¤rning | Reglerande block |
| **Push/Pull (Pi/Arrigo)** | Kommunicerar data till/ frÃ¥n Ã¶verordnat system | Kommunikationsblock |
| **Runtime Snapshot** | Lagrar och Ã¥teranvÃ¤nder lÃ¤rda vÃ¤rden | Diagnostiskt block |

Alla delar bygger pÃ¥ samma grundtanke:
> *Data flÃ¶dar endast Ã¥t ett hÃ¥ll â€“ beslut fattas centralt i driftsmodellen, inte i HMI eller UI.*

---

## ğŸ” Samspel och beroenden

### 1. Estimator
Tar in data som:  
- utetemperatur, vÃ¤rmebehov, topologi (byggnadstyp), profiler, och tidigare mÃ¶nster.  
Ger ut:  
- `VVP_H_BASE` = basbehov i timmar.  
- Initierar vÃ¤rden till Planner.

### 2. Planner
HjÃ¤rnan fÃ¶r dygnsplanen.  
Fyller ut `VV_PLAN[0..95]` med aktivt schema baserat pÃ¥:
- Billigast-princip (RANK_W)  
- Ankare (morgon/kvÃ¤ll)  
- Budget (minuter per fÃ¶nster)  
- Gap och in-row regler  
- Slack (extra kapacitet)

Planner Ã¤r ocksÃ¥ den modul som reagerar pÃ¥:
- UI-fÃ¶rÃ¤ndring  
- Profilbyte  
- Manuell trigging  
och kÃ¶rs **endast en gÃ¥ng per cykel**.

### 3. Controller
VerkstÃ¤ller planerade perioder i realtid.  
Den reglerar:
- `DO_VV` (digitalt utgÃ¥ngsvÃ¤rde)  
- TemperaturgrÃ¤nser  
- LÃ¤rande (t.ex. hur lÃ¥ng tid produktionen tar, Ã¥terhÃ¤mtning, m.m.)

Controller kan Ã¤ven pÃ¥verka Planner genom feedback:
> â€œJag blev klar tidigare Ã¤n planeratâ€ â†’ returnerar â€œcap slackâ€ till Planner.  
> â€œJag hann inte klartâ€ â†’ begÃ¤r Ã¶kad budget till nÃ¤sta cykel.

---

## ğŸ’¬ Modulernas samverkan (â€kompislogikâ€)

Systemet behandlar alla processer som â€œvÃ¤nnerâ€:
- Varmvatten kan erbjuda vÃ¤rmen oanvÃ¤nda timmar.
- VÃ¤rmen kan lÃ¤mna tillbaka effekt vid lÃ¥g efterfrÃ¥gan.
- Om bÃ¥da Ã¤r nÃ¶jda â†’ energilagring eller laddning prioriteras.
- Allt sker under principen **â€œomtanke och samverkanâ€**.

---

## âš™ï¸ Centrala styrprinciper

| Princip | FÃ¶rklaring |
|----------|-------------|
| **Billigast fÃ¶rst** | All planering sker utifrÃ¥n prisrank (`RANK_W`), men med respekt fÃ¶r tidsfÃ¶nster. |
| **Clampning** | Alla anvÃ¤ndarvÃ¤rden begrÃ¤nsas till giltiga intervall (0â€“96 perioder, 0â€“24 timmar). |
| **Ã…terhÃ¥llsamhet** | Systemet vÃ¤ljer aldrig fler timmar Ã¤n nÃ¶dvÃ¤ndigt. |
| **LÃ¤rande** | Efter varje cykel uppdateras runtime-vÃ¤rden. |
| **Oberoende** | UI och plan Ã¤r separata; UI Ã¤ndrar inte drift utan commit via flaggor. |

---

## ğŸ§® Variabelfilosofi (EXOL-standard)

| Typ | Prefix | Betydelse |
|------|---------|-----------|
| `R` | Runtime (berÃ¤knad) | anvÃ¤nds i realtid, t.ex. `VVP_H_BASE_R` |
| `UI` | AnvÃ¤ndargrÃ¤nssnitt | HMI-data som Ã¤ndras manuellt |
| `I` | Index | anvÃ¤nds fÃ¶r periodrÃ¤kning (0â€“95) |
| `L` | Latch | tillfÃ¤lliga engÃ¥ngssignaler |
| `X` | Timer / Tid / Dag | anvÃ¤nds fÃ¶r kvartsbaserade loopar |
| `P` | Period | anvÃ¤nds fÃ¶r antal kvartstimmar |

---

## ğŸ§  SjÃ¤lvinlÃ¤rning & AI

MÃ¥let Ã¤r att varje del ska kunna *reflektera Ã¶ver sitt eget beteende*.  
Exempel:
- Controller mÃ¤ter hur lÃ¥ng tid VV-produktionen tar â†’ ger feedback till Planner.  
- Planner justerar nÃ¤sta dags budget.  
- Estimator finjusterar topologi och helgfaktor baserat pÃ¥ resultat.

SÃ¥ smÃ¥ningom ska systemet fÃ¶rstÃ¥:
> â€œJag har en kall natt framfÃ¶r mig och hÃ¶ga elpriser i morgon â€”  
jag laddar vÃ¤rme eller varmvatten redan nu.â€

---

## ğŸ”‹ Framtida moduler

| Modul | Funktion | Status |
|--------|-----------|--------|
| **Battery Manager** | Styr laddning/ urladdning efter pris och behov | Planerad |
| **Solar Integration** | Styr fÃ¶rbrukning utifrÃ¥n solproduktion | Planerad |
| **Effect Guard** | JÃ¤mnar ut effektuttag, skyddar huvudsÃ¤kring | Delvis implementerad |
| **Predictive AI** | Prognoser baserade pÃ¥ vÃ¤der och historik | Planerad |
| **Visualization Dashboard** | Grafisk vy Ã¶ver alla 96 perioder | PÃ¥gÃ¥ende |

---

## ğŸª„ Filosofi
Systemet ska vara:
- SjÃ¤lvfÃ¶rklarande.
- SjÃ¤lvlÃ¤rande.
- SjÃ¤lvjusterande.

MÃ¥let Ã¤r **ett system som tÃ¤nker som en mÃ¤nniska â€“ men reagerar som en maskin.**

---

## ğŸ”š Sammanfattning

Den adaptiva driftsmodellen Ã¤r **ett ekosystem av logik**.  
Den Ã¤r byggd fÃ¶r att leva lÃ¤nge, vÃ¤xa Ã¶ver tid och anpassa sig till verkligheten.

NÃ¤r Planner fungerar som tÃ¤nkt blir den inte bara en del i systemet â€”  
den blir *navet som alla andra moduler snurrar kring.*

